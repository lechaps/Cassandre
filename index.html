<!DOCTYPE html>
<html>
  <head>
    <title>JSON to Input Fields</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <link rel="stylesheet" href="gantt/codebase/dhtmlxgantt.css" type="text/css">
    <script src="gantt/codebase/dhtmlxgantt.js"></script>
    <style>
      html, body {
        height: 100%;
        /*padding: 0px;
        margin: 0px;
        overflow: hidden;*/
      }
      .project-container {
        margin-bottom: 20px;
        border: 1px solid #ccc;
        padding: 10px;
      }
	  </style>
  </head>
  <body>
    <form>
      <input type="file" id="file">
      <input type="submit" value="Upload">
    </form>
    <button id="downloadButton" class="btn btn-primary">Download JSON</button>
    <div id="tableContainer"></div>
    <div id="gantt_here" style='width:100%; height:100%;'></div>
    <script>
      gantt.config.date_format = "%Y-%m-%d";
      gantt.config.scales = [
        {unit: "month", step: 1, format: "%M"},
        {unit: "year", step: 1, format: "%Y"},
      ];
      gantt.config.scale_height = 3*28;
      gantt.init("gantt_here", new Date(2022, 01, 10), new Date(2023, 03, 20));
      gantt.config.touch = "force";
      var demo_tasks = {
        "data":[
          {"id":11, "text":"Project #1", "start_date":"2022-03-28", "duration":"11", "progress": 0.6, "open": true},
          {"id":1, "text":"Project #2", "start_date":"2022-04-01", "duration":"18", "progress": 0.4, "open": true},

          {"id":2, "text":"Task #1", "start_date":"2022-04-02", "duration":"80", "parent":"1", "progress":0.5, "open": true},
          {"id":3, "text":"Task #2", "start_date":"2022-05-11", "duration":"80", "parent":"1", "progress": 0.6, "open": true},
          {"id":4, "text":"Task #3", "start_date":"2022-06-13", "duration":"60", "parent":"1", "progress": 0.5, "open": true},
          {"id":5, "text":"Task #1.1", "start_date":"2022-04-02", "duration":"70", "parent":"2", "progress": 0.6, "open": true},
          {"id":6, "text":"Task #1.2", "start_date":"2022-05-03", "duration":"70", "parent":"2", "progress": 0.6, "open": true},
          {"id":7, "text":"Task #2.1", "start_date":"2022-07-11", "duration":"80", "parent":"3", "progress": 0.6, "open": true},
          {"id":8, "text":"Task #3.1", "start_date":"2022-06-14", "duration":"50", "parent":"4", "progress": 0.5, "open": true},
          {"id":9, "text":"Task #3.2", "start_date":"2022-08-14", "duration":"40", "parent":"4", "progress": 0.5, "open": true},
          {"id":10, "text":"Task #3.3", "start_date":"2022-02-14", "duration":"30", "parent":"4", "progress": 0.5, "open": true},
          
          {"id":12, "text":"Task #1", "start_date":"2022-05-03", "duration":"50", "parent":"11", "progress": 1, "open": true},
          {"id":13, "text":"Task #2", "start_date":"2022-08-02", "duration":"70", "parent":"11", "progress": 0.5, "open": true},
          {"id":14, "text":"Task #3", "start_date":"2022-10-02", "duration":"60", "parent":"11", "progress": 0.8, "open": true},
          {"id":15, "text":"Task #4", "start_date":"2022-09-01", "duration":"50", "parent":"11", "progress": 0.2, "open": true},
          {"id":16, "text":"Task #5", "start_date":"2022-10-01", "duration":"70", "parent":"11", "progress": 0, "open": true},

          {"id":17, "text":"Task #2.1", "start_date":"2022-03-01", "duration":"20", "parent":"13", "progress": 1, "open": true},
          {"id":18, "text":"Task #2.2", "start_date":"2022-02-01", "duration":"30", "parent":"13", "progress": 0.8, "open": true},
          {"id":19, "text":"Task #2.3", "start_date":"2022-05-01", "duration":"40", "parent":"13", "progress": 0.2, "open": true},
          {"id":20, "text":"Task #2.4", "start_date":"2022-07-01", "duration":"40", "parent":"13", "progress": 0, "open": true},
          {"id":21, "text":"Task #4.1", "start_date":"2022-08-01", "duration":"40", "parent":"15", "progress": 0.5, "open": true},
          {"id":22, "text":"Task #4.2", "start_date":"2022-02-01", "duration":"40", "parent":"15", "progress": 0.1, "open": true},
          {"id":23, "text":"Task #4.3", "start_date":"2022-09-01", "duration":"50", "parent":"15", "progress": 0, "open": true}
        ],
        "links":[
          {"id":"1","source":"1","target":"2","type":"1"},
          {"id":"2","source":"2","target":"3","type":"0"},
          {"id":"3","source":"3","target":"4","type":"0"},
          {"id":"4","source":"2","target":"5","type":"2"},
          {"id":"5","source":"2","target":"6","type":"2"},
          {"id":"6","source":"3","target":"7","type":"2"},
          {"id":"7","source":"4","target":"8","type":"2"},
          {"id":"8","source":"4","target":"9","type":"2"},
          {"id":"9","source":"4","target":"10","type":"2"},
          {"id":"10","source":"11","target":"12","type":"1"},
          {"id":"11","source":"11","target":"13","type":"1"},
          {"id":"12","source":"11","target":"14","type":"1"},
          {"id":"13","source":"11","target":"15","type":"1"},
          {"id":"14","source":"11","target":"16","type":"1"},
          {"id":"15","source":"13","target":"17","type":"1"},
          {"id":"16","source":"17","target":"18","type":"0"},
          {"id":"17","source":"18","target":"19","type":"0"},
          {"id":"18","source":"19","target":"20","type":"0"},
          {"id":"19","source":"15","target":"21","type":"2"},
          {"id":"20","source":"15","target":"22","type":"2"},
          {"id":"21","source":"15","target":"23","type":"2"}
        ]
      };
      gantt.parse(demo_tasks);

    </script>
    <script>
      document.querySelector("form").addEventListener("submit", function(e){
        e.preventDefault();
        var file = document.querySelector("#file").files[0];
        var reader = new FileReader();
        reader.onload = function(){
          var data = JSON.parse(reader.result);
          data.forEach(function(project) {
            var projectName = project.name;
            var containerProject = document.createElement("div");
            containerProject.setAttribute("class","project-container");
            var h2 = document.createElement("h2");
            h2.innerHTML = projectName;
            containerProject.appendChild(h2);
            project.stages.forEach(function(stage) {
              var row = document.createElement("div");
              row.setAttribute("class", "row");
              var inputName = document.createElement("input");
              inputName.setAttribute("type", "text");
              inputName.setAttribute("value", stage.name);
              inputName.setAttribute("class", "col form-control");
              row.appendChild(inputName);
              var inputStartDate = document.createElement("input");
              inputStartDate.setAttribute("type", "text");
              inputStartDate.setAttribute("value", stage.start_date);
              inputStartDate.setAttribute("class", "col form-control");
              row.appendChild(inputStartDate);
              var inputEndDate = document.createElement("input");
              inputEndDate.setAttribute("type", "text");
              inputEndDate.setAttribute("value", stage.end_date);
              inputEndDate.setAttribute("class", "col form-control");
              row.appendChild(inputEndDate);
              containerProject.appendChild(row);
              //add the stage to the gantt chart
              gantt.addTask({
                id: stage.id,
                text: stage.name,
                start_date: stage.start_date,
                end_date: stage.end_date
              });
            });
            document.querySelector("#tableContainer").appendChild(containerProject);
          });
        };
        reader.readAsText(file);
      });
    </script>
    <script>
      document.querySelector("#downloadButton").addEventListener("click", function(){
        var data = [];
        var projects = document.querySelectorAll(".project-container");
          projects.forEach(function(project){
          var projectName = project.querySelector("h2").innerHTML;
          var stages = project.querySelectorAll(".row");
          var projectStages = [];
          stages.forEach(function(stage){
            var stageName = stage.querySelector("input[type=text]:nth-child(1)").value;
            var stageStartDate = stage.querySelector("input[type=text]:nth-child(2)").value;
            var stageEndDate = stage.querySelector("input[type=text]:nth-child(3)").value;
            projectStages.push({
              "name": stageName,
              "start_date": stageStartDate,
              "end_date": stageEndDate
            });
          });
          data.push({
            "name": projectName,
            "stages": projectStages
          });
          gantt.init("gantt_here");
        });
        var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));
        var downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "trajectory.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
      }); 
    </script>
  </body>
</html>
